---
name: Docker Compose Updates

permissions:
  actions: none
  checks: none # add custom pass/fail checks to the PR
  contents: read # git permissions to repo pull/push
  deployments: none
  issues: none # read/write to repo Issues
  packages: none # read/write to repo Packages (ghcr, gems, npm)
  pull-requests: read # read/write to repo PRs
  repository-projects: none
  security-events: none # read/write to repo Security tab API
  statuses: read # read/write to repo custom statuses and checks

on:
  workflow_dispatch: {}
  push:
    paths:
      - "services/**"
      - ".github/workflows/compose.yml"
      - "run.yaml"
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Docker Compose Files
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          persist-credentials: false

      - name: Set up Docker
        uses: docker/setup-buildx-action@1583c0f09d26c58c59d25b0eef29792b7ce99d9a

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62
        with:
          dir_names: "true"
          files: |
            services/**

      - name: List all changed files (Debug only)
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          # shellcheck disable=2086
          for file in ${ALL_CHANGED_FILES}; do
            echo "$file was changed"
          done

      - name: Validate docker-compose.yaml
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          # shellcheck disable=2086
          for file in ${ALL_CHANGED_FILES}; do
            echo "##### Validating $file #####" &&
            cd $file &&
            docker compose config --quiet &&
            cd $GITHUB_WORKSPACE &&
            echo "##### Finished validating $file #####"
          done

  compose:
    runs-on: ubuntu-latest
    name: Deploy Docker Compose Files
    needs: validate
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: "3.x"

      - name: Install Ansible
        run: |
          python3 -m pip install --upgrade pip
          pip3 install ansible

      - name: Install Ansible-Galaxy Requirements
        run: |
          ansible-galaxy install -r requirements.yaml --ignore-errors

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62
        with:
          dir_names: "true"
          files: |
            services/**

      - name: Tailscale Login
        uses: tailscale/github-action@6d2f2497d75aa425c547811c667f6783fe78ade7
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Ansible Deploy Playbook
        run: |
          ansible-playbook -i inventory/vms.yaml run.yaml
