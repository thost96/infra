---
name: Cloud Infrastructure Updates

permissions:
  actions: none
  checks: none # add custom pass/fail checks to the PR
  contents: read # git permissions to repo pull/push
  deployments: none
  issues: none # read/write to repo Issues
  packages: none # read/write to repo Packages (ghcr, gems, npm)
  pull-requests: read # read/write to repo PRs
  repository-projects: none
  security-events: none # read/write to repo Security tab API
  statuses: read # read/write to repo custom statuses and checks

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * 0"
  push:
    paths:
      - "inventory/cloud.yaml"
      - "playbooks/os-updates.yaml"
      - "playbooks/pihole-update.yaml"
      - "playbooks/nextcloud-update.yaml"
      - "playbooks/mailcow-update.yaml"
      - "playbooks/docker-prune.yaml"
      - "playbooks/setup-proxmox.yaml"
      - "playbooks/setup-compose.yaml"

jobs:
  os-updates:
    runs-on: ubuntu-latest
    concurrency:
      group: cloud-infra-${{ github.ref }}
      cancel-in-progress: true
    timeout-minutes: 60
    steps:
      - name: Setup Ansible
        uses: ./.github/actions/setup-ansible
        with:
          python-version: "3.x"
          requirements-file: "requirements.txt"
          extra-packages: "paramiko"
          ts-oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          ts-oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tailscale-tags: tag:ci

      - name: Run Proxmox VE and Quorum Updates
        uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68
        with:
          timeout_seconds: 600
          max_attempts: 3
          command: ansible-playbook -i inventory/cloud.yaml -l pve:quorum playbooks/os-updates.yaml

      - name: Run PVE Pre-Requisites Install with Retry
        uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68
        with:
          timeout_seconds: 600
          max_attempts: 3
          command: ansible-playbook -i inventory/cloud.yaml -l pve playbooks/setup-proxmox.yaml

      - name: Run LXC Pre-Requisites Install with Retry
        uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68
        with:
          timeout_seconds: 600
          max_attempts: 3
          command: ansible-playbook -i inventory/cloud.yaml -l compose playbooks/setup-compose.yaml

      - name: Run VM and LXC OS Updates
        uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68
        with:
          timeout_seconds: 600
          max_attempts: 3
          command: ansible-playbook -i inventory/cloud.yaml -l !pve playbooks/os-updates.yaml

  app-updates:
    runs-on: ubuntu-latest
    concurrency:
      group: cloud-app-${{ github.ref }}
      cancel-in-progress: true
    timeout-minutes: 60
    steps:
      - name: Setup Ansible
        uses: ./.github/actions/setup-ansible
        with:
          extra-packages: "paramiko"
          ts-oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          ts-oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}

      - name: Run Pihole Update
        uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68
        with:
          timeout_seconds: 600
          max_attempts: 1
          command: ansible-playbook -i inventory/cloud.yaml playbooks/pihole-update.yaml

      - name: Run Nextcloud Update
        uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68
        with:
          timeout_seconds: 600
          max_attempts: 1
          command: ansible-playbook -i inventory/cloud.yaml playbooks/nextcloud-update.yaml

      - name: Run Mailcow Update
        uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68
        with:
          timeout_seconds: 600
          max_attempts: 1
          command: ansible-playbook -i inventory/cloud.yaml playbooks/mailcow-update.yaml

  cleanup:
    runs-on: ubuntu-latest
    concurrency:
      group: cloud-cleanup-${{ github.ref }}
      cancel-in-progress: true
    timeout-minutes: 60
    steps:
      - name: Setup Ansible
        uses: ./.github/actions/setup-ansible
        with:
          extra-packages: "docker paramiko"
          ts-oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          ts-oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}

      - name: Run Docker Prune
        uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68
        with:
          timeout_seconds: 600
          max_attempts: 3
          command: ansible-playbook -i inventory/cloud.yaml -l compose:mailcow playbooks/docker-prune.yaml
