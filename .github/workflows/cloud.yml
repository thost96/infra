---
name: Cloud Infrastructure Updates

permissions:
  actions: none
  checks: none # add custom pass/fail checks to the PR
  contents: read # git permissions to repo pull/push
  deployments: none
  issues: none # read/write to repo Issues
  packages: none # read/write to repo Packages (ghcr, gems, npm)
  pull-requests: read # read/write to repo PRs
  repository-projects: none
  security-events: none # read/write to repo Security tab API
  statuses: read # read/write to repo custom statuses and checks

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * 0" # Sonntag 14 Uhr

jobs:
  os-updates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@18566f86b301499665bd3eb1a2247e0849c64fa5
        with:
          python-version: "3.x"

      - name: Install Ansible
        run: |
          python3 -m pip install --upgrade pip
          pip3 install ansible

      - name: Tailscale Login
        uses: tailscale/github-action@aa604318b61e5b25107287e0d07db6a08b3e72c0
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Run Proxmox VE and Quorum Updates
        run: |
          ansible-playbook -i inventory/cloud.yaml -l pve:quorum playbooks/os-updates.yaml

      - name: Run VM and LXC OS Updates
        run: |
          ansible-playbook -i inventory/cloud.yaml -l !pve playbooks/os-updates.yaml

  app-updates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@18566f86b301499665bd3eb1a2247e0849c64fa5
        with:
          python-version: "3.x"

      - name: Install Ansible
        run: |
          python3 -m pip install --upgrade pip
          pip3 install ansible

      - name: Tailscale Login
        uses: tailscale/github-action@aa604318b61e5b25107287e0d07db6a08b3e72c0
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Run Pihole Update
        run: |
          ansible-playbook -i inventory/cloud.yaml playbooks/pihole-update.yaml

      # - name: Run Nextcloud Update
      #   run: |
      #     ansible-playbook -i inventory/cloud.yaml playbooks/nextcloud-update.yaml

      - name: Run Mailcow Update
        run: |
          ansible-playbook -i inventory/cloud.yaml playbooks/mailcow-update.yaml

  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@18566f86b301499665bd3eb1a2247e0849c64fa5
        with:
          python-version: "3.x"

      - name: Install Ansible
        run: |
          python3 -m pip install --upgrade pip
          pip3 install ansible docker

      - name: Tailscale Login
        uses: tailscale/github-action@aa604318b61e5b25107287e0d07db6a08b3e72c0
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Run Docker Prune
        run: |
          ansible-playbook -i inventory/cloud.yaml -l compose:mailcow playbooks/docker-prune.yaml
