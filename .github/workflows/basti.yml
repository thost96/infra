---
name: Basti Infrastructure Updates

permissions:
  actions: none
  checks: none
  contents: read
  deployments: none
  issues: none
  packages: none
  pull-requests: read
  repository-projects: none
  security-events: none
  statuses: read

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * *"
  push:
    paths:
      - "inventory/basti.yaml"
      - "playbooks/os-updates.yaml"
      - "playbooks/pihole-update.yaml"
      - "playbooks/setup-proxmox.yaml"

jobs:
  cache:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548
        with:
          python-version: "3.x"
          cache: pip

      - name: Cache pip packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: ~/.cache/pip
          key: pip
          restore-keys: pip

      - name: Install Ansible
        run: |
          pip install --no-cache-dir ansible paramiko

  os-updates:
    needs: cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548
        with:
          python-version: "3.x"
          cache: pip

      - name: Restore pip cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: ~/.cache/pip
          key: pip

      - name: Install Ansible
        run: pip install --no-cache-dir ansible paramiko

      - name: Tailscale Login
        uses: tailscale/github-action@dea278bd44bcef18a8d421f079a1f1f50171ed63
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Run PVE Pre-Requisites Install with Retry
        uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68
        with:
          timeout_seconds: 600
          max_attempts: 3
          command: ansible-playbook -i inventory/basti.yaml playbooks/setup-proxmox.yaml

      - name: Run OS Updates with Retry
        uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68
        with:
          timeout_seconds: 600
          max_attempts: 3
          command: ansible-playbook -i inventory/basti.yaml playbooks/os-updates.yaml

  app-updates:
    needs: cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548
        with:
          python-version: "3.x"
          cache: pip

      - name: Restore pip cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: ~/.cache/pip
          key: pip

      - name: Install Ansible
        run: pip install --no-cache-dir ansible paramiko

      - name: Tailscale Login
        uses: tailscale/github-action@dea278bd44bcef18a8d421f079a1f1f50171ed63
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Run Pihole Update
        uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68
        with:
          timeout_seconds: 600
          max_attempts: 3
          command: ansible-playbook -i inventory/basti.yaml playbooks/pihole-update.yaml
